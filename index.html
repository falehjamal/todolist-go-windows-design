<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>CRUD Pelanggan</title>
    <script src="alpine.min.js" defer></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        font-size: 12px;
        background: linear-gradient(
          to bottom,
          #a8c6e8 0%,
          #6b9bc3 50%,
          #a8c6e8 100%
        );
        min-height: 100vh;
        color: #1e1e1e;
        padding: 20px;
      }
      .window {
        max-width: 900px;
        margin: 0 auto;
        border: 1px solid #6b9bc3;
        border-radius: 6px;
        background: #f0f4f8;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(255, 255, 255, 0.3) inset;
        overflow: hidden;
      }
      .titlebar {
        background: linear-gradient(
          to bottom,
          #4a90c2 0%,
          #2e6da4 40%,
          #1e5799 60%,
          #2e6da4 100%
        );
        color: #fff;
        font-weight: 600;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }
      .titlebar-icon {
        width: 20px;
        height: 20px;
        background: linear-gradient(to bottom, #fff, #e0e8f0);
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #2e6da4;
        border-radius: 3px;
      }
      .toolbar {
        padding: 10px 12px;
        background: linear-gradient(to bottom, #fafafa, #ececec);
        border-bottom: 1px solid #d0d0d0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .toolbar label {
        font-size: 11px;
        color: #555;
      }
      .input-field {
        padding: 5px 8px;
        font-family: inherit;
        font-size: 12px;
        border: 1px solid #abadb3;
        border-radius: 4px;
        background: #fff;
      }
      .input-field:focus {
        outline: none;
        border-color: #5c9fd4;
        box-shadow: 0 0 0 2px rgba(92, 159, 212, 0.25);
      }
      .btn {
        padding: 5px 14px;
        font-family: inherit;
        font-size: 12px;
        background: linear-gradient(to bottom, #f5f5f5, #e5e5e5);
        border: 1px solid #acacac;
        border-radius: 4px;
        cursor: pointer;
        color: #1e1e1e;
      }
      .btn:hover {
        background: linear-gradient(to bottom, #e8f4fc, #d0e8f8);
        border-color: #7eb4ea;
      }
      .btn:disabled {
        color: #a0a0a0;
        cursor: default;
      }
      .btn-danger {
        background: linear-gradient(to bottom, #f5e5e5, #e5d5d5);
        border-color: #c0a0a0;
      }
      .btn-danger:hover {
        background: linear-gradient(to bottom, #ffe0e0, #ffc8c8);
        border-color: #d08080;
        color: #a00;
      }
      .content {
        padding: 12px;
      }
      .table-container {
        background: #fff;
        border: 1px solid #c8c8c8;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 400px;
      }
      .table-wrapper {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid #e8e8e8;
      }
      th {
        background: linear-gradient(to bottom, #5a96c8, #3a7ab8);
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        user-select: none;
        position: relative;
      }
      th:hover {
        background: linear-gradient(to bottom, #6aa6d8, #4a8ac8);
      }
      th .sort-icon {
        margin-left: 5px;
        font-size: 10px;
      }
      .search-row th {
        background: linear-gradient(to bottom, #e8e8e8, #d8d8d8);
        padding: 6px 8px;
      }
      .search-row input {
        width: 100%;
        padding: 4px 6px;
        font-size: 11px;
        border: 1px solid #b0b0b0;
        border-radius: 3px;
      }
      .search-row input:focus {
        outline: none;
        border-color: #5c9fd4;
      }
      tr:hover td {
        background: #f0f6fc;
      }
      table {
        table-layout: fixed;
      }
      .col-id {
        width: 60px;
      }
      .col-nama {
        width: 200px;
      }
      .col-alamat {
        width: auto;
      }
      .col-actions {
        width: 70px;
        text-align: center;
      }
      td,
      th {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      td[title] {
        cursor: default;
      }
      .pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
        border-top: 1px solid #c8c8c8;
        font-size: 11px;
        color: #555;
      }
      .pagination-controls {
        display: flex;
        gap: 4px;
        align-items: center;
      }
      .page-btn {
        padding: 4px 10px;
        font-size: 11px;
        background: linear-gradient(to bottom, #f5f5f5, #e5e5e5);
        border: 1px solid #acacac;
        border-radius: 3px;
        cursor: pointer;
      }
      .page-btn:hover:not(:disabled) {
        background: linear-gradient(to bottom, #e8f4fc, #d0e8f8);
        border-color: #7eb4ea;
      }
      .page-btn:disabled {
        color: #aaa;
        cursor: default;
      }
      .page-btn.active {
        background: linear-gradient(to bottom, #4a90c2, #2e6da4);
        color: #fff;
        border-color: #1e5799;
      }
      .info-bar {
        display: flex;
        gap: 15px;
      }
      .loading {
        text-align: center;
        padding: 30px;
        color: #666;
      }
      .empty {
        text-align: center;
        padding: 30px;
        color: #888;
      }
      select {
        padding: 4px 8px;
        font-size: 11px;
        border: 1px solid #acacac;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div x-data="app()" x-init="load()">
      <div class="window">
        <div class="titlebar">
          <div class="titlebar-icon">ðŸ‘¥</div>
          <span>CRUD Pelanggan</span>
        </div>

        <!-- Add Form -->
        <div class="toolbar">
          <label>Nama:</label>
          <input
            type="text"
            class="input-field"
            x-model="form.nama"
            placeholder="Nama pelanggan"
            style="width: 180px"
          />
          <label>Alamat:</label>
          <input
            type="text"
            class="input-field"
            x-model="form.alamat"
            placeholder="Alamat lengkap"
            style="width: 250px"
            @keydown.enter="add()"
          />
          <button
            class="btn"
            @click="add()"
            :disabled="!form.nama.trim() || !form.alamat.trim()"
          >
            + Tambah
          </button>
          <div style="margin-left: auto">
            <label>Per halaman:</label>
            <select x-model="limit" @change="page=1; load()">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <div class="content">
          <div class="table-container">
            <div class="table-wrapper">
              <table>
                <thead>
                  <!-- Search Row -->
                  <tr class="search-row">
                    <th class="col-id"></th>
                    <th class="col-nama">
                      <input
                        type="text"
                        x-model="search.nama"
                        @input="debounceSearch()"
                        placeholder="Cari nama..."
                      />
                    </th>
                    <th class="col-alamat">
                      <input
                        type="text"
                        x-model="search.alamat"
                        @input="debounceSearch()"
                        placeholder="Cari alamat..."
                      />
                    </th>
                    <th class="col-actions"></th>
                  </tr>
                  <!-- Header Row -->
                  <tr>
                    <th class="col-id" @click="setSort('id')">
                      ID
                      <span class="sort-icon" x-text="getSortIcon('id')"></span>
                    </th>
                    <th class="col-nama" @click="setSort('nama')">
                      Nama
                      <span
                        class="sort-icon"
                        x-text="getSortIcon('nama')"
                      ></span>
                    </th>
                    <th class="col-alamat" @click="setSort('alamat')">
                      Alamat
                      <span
                        class="sort-icon"
                        x-text="getSortIcon('alamat')"
                      ></span>
                    </th>
                    <th class="col-actions">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-if="loading">
                    <tr>
                      <td colspan="4" class="loading">Memuat data...</td>
                    </tr>
                  </template>
                  <template x-if="!loading && data.length === 0">
                    <tr>
                      <td colspan="4" class="empty">Tidak ada data</td>
                    </tr>
                  </template>
                  <template x-for="item in data" :key="item.id">
                    <tr>
                      <td class="col-id" x-text="item.id"></td>
                      <td
                        class="col-nama"
                        :title="item.nama"
                        x-text="item.nama"
                      ></td>
                      <td
                        class="col-alamat"
                        :title="item.alamat"
                        x-text="item.alamat"
                      ></td>
                      <td class="col-actions">
                        <button
                          class="btn btn-danger"
                          style="padding: 2px 8px; font-size: 10px"
                          @click="remove(item.id)"
                        >
                          Hapus
                        </button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <div class="info-bar">
            <span>Total: <strong x-text="total"></strong> data</span>
            <span x-show="filtered !== total"
              >Hasil filter: <strong x-text="filtered"></strong
            ></span>
            <span
              >Halaman <strong x-text="page"></strong> dari
              <strong x-text="totalPages"></strong
            ></span>
          </div>
          <div class="pagination-controls">
            <button class="page-btn" @click="goPage(1)" :disabled="page === 1">
              Â«
            </button>
            <button
              class="page-btn"
              @click="goPage(page - 1)"
              :disabled="page === 1"
            >
              â€¹
            </button>
            <template x-for="p in visiblePages" :key="p">
              <button
                class="page-btn"
                :class="{ active: p === page }"
                @click="goPage(p)"
                x-text="p"
              ></button>
            </template>
            <button
              class="page-btn"
              @click="goPage(page + 1)"
              :disabled="page >= totalPages"
            >
              â€º
            </button>
            <button
              class="page-btn"
              @click="goPage(totalPages)"
              :disabled="page >= totalPages"
            >
              Â»
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function app() {
        return {
          data: [],
          total: 0,
          filtered: 0,
          page: 1,
          limit: 10,
          sort: "id",
          order: "asc",
          search: { nama: "", alamat: "" },
          form: { nama: "", alamat: "" },
          loading: false,
          searchTimeout: null,

          get totalPages() {
            return Math.max(1, Math.ceil(this.filtered / this.limit));
          },

          get visiblePages() {
            const pages = [];
            const total = this.totalPages;
            let start = Math.max(1, this.page - 2);
            let end = Math.min(total, this.page + 2);
            if (end - start < 4) {
              if (start === 1) end = Math.min(total, 5);
              else start = Math.max(1, total - 4);
            }
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
          },

          async load() {
            this.loading = true;
            try {
              const params = new URLSearchParams({
                page: this.page,
                limit: this.limit,
                sort: this.sort,
                order: this.order,
                search_nama: this.search.nama,
                search_alamat: this.search.alamat,
              });
              const res = await fetch("/api/data?" + params);
              const json = await res.json();
              this.data = json.data || [];
              this.total = json.total;
              this.filtered = json.filtered;
            } catch (e) {
              console.error("Load error:", e);
            } finally {
              this.loading = false;
            }
          },

          debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
              this.page = 1;
              this.load();
            }, 300);
          },

          setSort(col) {
            if (this.sort === col) {
              this.order = this.order === "asc" ? "desc" : "asc";
            } else {
              this.sort = col;
              this.order = "asc";
            }
            this.load();
          },

          getSortIcon(col) {
            if (this.sort !== col) return "";
            return this.order === "asc" ? "â–²" : "â–¼";
          },

          goPage(p) {
            if (p < 1 || p > this.totalPages) return;
            this.page = p;
            this.load();
          },

          async add() {
            const nama = this.form.nama.trim();
            const alamat = this.form.alamat.trim();
            if (!nama || !alamat) return;
            try {
              const params = new URLSearchParams({ nama, alamat });
              await fetch("/api/add?" + params);
              this.form = { nama: "", alamat: "" };
              this.load();
            } catch (e) {
              console.error("Add error:", e);
            }
          },

          async remove(id) {
            if (!confirm("Hapus pelanggan ini?")) return;
            try {
              await fetch("/api/delete?id=" + id);
              this.load();
            } catch (e) {
              console.error("Delete error:", e);
            }
          },
        };
      }
    </script>
  </body>
</html>
